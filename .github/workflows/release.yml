name: Release

on:
  push:
    tags:
      - 'v*'

permissions:
  contents: write

jobs:
  # =========================================================================
  # Run full test suite before releasing
  # =========================================================================
  test:
    strategy:
      matrix:
        os: [ubuntu-latest, macos-latest, windows-latest]
    runs-on: ${{ matrix.os }}

    steps:
    - uses: actions/checkout@v4
      with:
        submodules: recursive

    - name: Install dependencies (Linux)
      if: runner.os == 'Linux'
      run: sudo apt-get update && sudo apt-get install -y cmake ninja-build

    - name: Install dependencies (macOS)
      if: runner.os == 'macOS'
      run: brew install cmake ninja

    - name: Configure
      run: cmake -B build -DCMAKE_BUILD_TYPE=Release -DBUILD_TESTS=ON

    - name: Build
      run: cmake --build build --config Release --parallel 4

    - name: Test
      run: cd build && ctest -C Release --output-on-failure --timeout 120

  # =========================================================================
  # Build release artifacts
  # =========================================================================
  build-desktop:
    needs: test
    strategy:
      matrix:
        include:
          - os: ubuntu-latest
            artifact: linux-x64
          - os: macos-latest
            artifact: macos-universal
          - os: windows-latest
            artifact: windows-x64
    runs-on: ${{ matrix.os }}

    steps:
    - uses: actions/checkout@v4
      with:
        submodules: recursive

    - name: Install dependencies (Linux)
      if: runner.os == 'Linux'
      run: sudo apt-get update && sudo apt-get install -y cmake ninja-build

    - name: Install dependencies (macOS)
      if: runner.os == 'macOS'
      run: brew install cmake ninja

    - name: Build Release
      run: |
        cmake -B build -DCMAKE_BUILD_TYPE=Release -DBUILD_TESTS=OFF \
              -DCMAKE_INSTALL_PREFIX=install
        cmake --build build --config Release --parallel 4
        cmake --install build --config Release

    - name: Package
      run: |
        mkdir -p artifacts
        cp -r install/* artifacts/ 2>/dev/null || xcopy /s /e install artifacts\ 2>NUL || true
        cp CHANGELOG.md README.md artifacts/ 2>/dev/null || true

    - uses: actions/upload-artifact@v4
      with:
        name: ondeviceai-${{ matrix.artifact }}
        path: artifacts/

  build-ios:
    needs: test
    runs-on: macos-latest

    steps:
    - uses: actions/checkout@v4
      with:
        submodules: recursive

    - name: Build iOS (device arm64)
      run: |
        cmake -B build/ios-device -G Xcode \
              -DCMAKE_SYSTEM_NAME=iOS \
              -DCMAKE_OSX_ARCHITECTURES=arm64 \
              -DCMAKE_OSX_DEPLOYMENT_TARGET=12.0 \
              -DBUILD_IOS=ON -DBUILD_TESTS=OFF
        cmake --build build/ios-device --config Release -- -sdk iphoneos || true

    - name: Build iOS (simulator)
      run: |
        cmake -B build/ios-sim -G Xcode \
              -DCMAKE_SYSTEM_NAME=iOS \
              -DCMAKE_OSX_ARCHITECTURES="arm64;x86_64" \
              -DCMAKE_OSX_DEPLOYMENT_TARGET=12.0 \
              -DBUILD_IOS=ON -DBUILD_TESTS=OFF
        cmake --build build/ios-sim --config Release -- -sdk iphonesimulator || true

    - name: Package iOS Sources
      run: |
        mkdir -p artifacts/ios
        cp -r platforms/ios/*.swift artifacts/ios/
        cp -r platforms/ios/*.h artifacts/ios/
        cp -r platforms/ios/*.mm artifacts/ios/
        cp -r core/include artifacts/ios/

    - uses: actions/upload-artifact@v4
      with:
        name: ondeviceai-ios
        path: artifacts/

  build-android:
    needs: test
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v4
      with:
        submodules: recursive

    - name: Set up NDK
      uses: android-actions/setup-android@v3

    - name: Build Android
      run: |
        for abi in arm64-v8a armeabi-v7a x86_64; do
          echo "Building ${abi}..."
          cmake -B "build/android-${abi}" \
                -DCMAKE_TOOLCHAIN_FILE="${ANDROID_NDK_HOME}/build/cmake/android.toolchain.cmake" \
                -DANDROID_ABI="${abi}" \
                -DANDROID_PLATFORM=android-24 \
                -DCMAKE_BUILD_TYPE=Release \
                -DBUILD_ANDROID=ON -DBUILD_TESTS=OFF
          cmake --build "build/android-${abi}" --parallel 4 || true
        done

    - name: Package Android
      run: |
        mkdir -p artifacts/android/jniLibs
        for abi in arm64-v8a armeabi-v7a x86_64; do
          mkdir -p "artifacts/android/jniLibs/${abi}"
          find "build/android-${abi}" -name "*.so" -exec cp {} "artifacts/android/jniLibs/${abi}/" \; 2>/dev/null || true
        done
        cp platforms/android/OnDeviceAI.kt artifacts/android/
        cp platforms/android/build.gradle.kts artifacts/android/

    - uses: actions/upload-artifact@v4
      with:
        name: ondeviceai-android
        path: artifacts/

  # =========================================================================
  # Create GitHub Release
  # =========================================================================
  release:
    needs: [build-desktop, build-ios, build-android]
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v4

    - name: Download all artifacts
      uses: actions/download-artifact@v4
      with:
        path: release_artifacts/

    - name: Package artifacts
      run: |
        cd release_artifacts
        for dir in */; do
          name="${dir%/}"
          tar -czf "${name}.tar.gz" -C "${dir}" .
        done

    - name: Extract release notes from CHANGELOG
      id: changelog
      run: |
        VERSION="${GITHUB_REF_NAME#v}"
        NOTES=$(sed -n "/^## \[${VERSION}\]/,/^## \[/p" CHANGELOG.md | head -n -1)
        echo "notes<<EOF" >> $GITHUB_OUTPUT
        echo "${NOTES}" >> $GITHUB_OUTPUT
        echo "EOF" >> $GITHUB_OUTPUT

    - name: Create GitHub Release
      uses: softprops/action-gh-release@v2
      with:
        name: "OnDevice AI SDK ${{ github.ref_name }}"
        body: ${{ steps.changelog.outputs.notes }}
        files: |
          release_artifacts/*.tar.gz
        draft: false
        prerelease: false
